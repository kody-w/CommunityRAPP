name: Copilot Steward - Auto Cleanup

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      path:
        description: 'Directory to scan (default: entire repo)'
        required: false
        default: '.'
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        type: boolean
        default: false
      create_pr:
        description: 'Create PR for merges'
        required: false
        type: boolean
        default: true

jobs:
  steward-cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Configure Git
        run: |
          git config user.name "Copilot Steward"
          git config user.email "steward@rappverse.local"
      
      - name: Scan for duplicates
        id: scan
        run: |
          echo "ğŸ“š Copilot Steward - Scanning for duplicates..."
          python3 scripts/copilot_steward.py --scan --path "${{ github.event.inputs.path || '.' }}" | tee scan_output.txt
          
          # Check if duplicates found
          if grep -q "No versioned duplicates found" scan_output.txt; then
            echo "duplicates_found=false" >> $GITHUB_OUTPUT
            echo "âœ¨ Repository is clean!"
          else
            echo "duplicates_found=true" >> $GITHUB_OUTPUT
            echo "ğŸ” Duplicates found, proceeding with merge..."
          fi
      
      - name: Merge duplicates
        if: steps.scan.outputs.duplicates_found == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ”„ Merging duplicate files..."
          python3 scripts/copilot_steward.py --auto --path "${{ github.event.inputs.path || '.' }}"
      
      - name: Create Pull Request
        if: steps.scan.outputs.duplicates_found == 'true' && github.event.inputs.dry_run != 'true' && github.event.inputs.create_pr != 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[Steward] Auto-merge duplicate files"
          title: "ğŸ“š [Steward] Auto-merge duplicate files"
          body: |
            ## ğŸ“š Copilot Steward - Auto Cleanup
            
            This PR was automatically generated by the Copilot Steward daemon.
            
            ### Changes
            - Merged versioned duplicate files into canonical versions
            - See `.steward-manifest.json` for details
            
            ### Merge Strategy
            - **JSON arrays**: Union by ID field
            - **JSON objects**: Deep merge, latest timestamp wins
            - **Markdown/text**: Take highest version number
            
            ---
            *Auto-generated by Copilot Steward*
          branch: steward/auto-cleanup
          delete-branch: true
          labels: |
            automated
            cleanup
            steward
      
      - name: Dry run report
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” DRY RUN - Preview of changes:"
          python3 scripts/copilot_steward.py --auto --dry-run --path "${{ github.event.inputs.path || '.' }}"
