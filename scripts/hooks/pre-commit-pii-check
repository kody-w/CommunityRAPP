#!/bin/bash
# Pre-commit hook to check for potential PII
# Copy to .git/hooks/pre-commit and make executable

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Checking for potential PII in staged files..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_PII=0

# Patterns to check for (case insensitive)
PII_PATTERNS=(
    # Azure resource identifiers (specific patterns that shouldn't be hardcoded)
    "[a-z0-9]{8,}-[a-z0-9]{4,}\.azurewebsites\.net"
    "[a-z0-9]{8,}-[a-z0-9]{4,}\.openai\.azure\.com"
    "st[a-z0-9]{10,}"  # Storage account naming pattern

    # Subscription/tenant IDs
    "[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"

    # Email addresses (except example.com)
    "[a-zA-Z0-9._%+-]+@(?!example\.com)[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"

    # API keys (common patterns)
    "sk-[a-zA-Z0-9]{20,}"
    "api[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{20,}"
)

# Check each staged file
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        # Skip binary files
        if file "$FILE" | grep -q "text"; then
            for PATTERN in "${PII_PATTERNS[@]}"; do
                MATCHES=$(grep -inE "$PATTERN" "$FILE" 2>/dev/null | head -3)
                if [ -n "$MATCHES" ]; then
                    echo -e "${YELLOW}Potential PII found in $FILE:${NC}"
                    echo "$MATCHES"
                    echo ""
                    FOUND_PII=1
                fi
            done
        fi
    fi
done

if [ $FOUND_PII -eq 1 ]; then
    echo -e "${RED}==================================================${NC}"
    echo -e "${RED}WARNING: Potential PII detected in staged files!${NC}"
    echo -e "${RED}==================================================${NC}"
    echo ""
    echo "Please review the above matches and either:"
    echo "1. Replace real data with placeholders (YOUR_FUNCTION_APP, example.com, etc.)"
    echo "2. If these are false positives, commit with: git commit --no-verify"
    echo ""
    echo "Guidelines:"
    echo "  - Use YOUR_FUNCTION_APP instead of real Azure resource names"
    echo "  - Use example.com for email domains"
    echo "  - Use Demo/Contoso/Acme for company names"
    echo "  - Use generic titles (Contact A, Demo User) instead of real names"
    echo ""
    exit 1
fi

echo "No obvious PII detected."
exit 0
